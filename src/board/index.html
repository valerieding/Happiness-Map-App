<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="/static/main.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/board/index_style.css">
    <script type="application/javascript" src="/static/jquery-3.2.1.min.js"></script>
    <script type="application/javascript" src="/static/popper.min.js"></script>
    <script type="application/javascript" src="/static/bootstrap4.min.js"></script>
    <title>Message Board</title>
  </head>
    <script>
      $(function(){
        $("#myNav").load("../static/nav.html");
        //An example "add_vote", when really this will be done by the user on the voting page.
        //Can change 'happiness_level' to see different welcome text (upon next reload)
              // $.ajax({
              //   url: 'request/add_vote',
              //   type: 'post',
              //   dataType: 'json',
              //   data: {'latitude': 20, 'longitude': 10, 'happiness_level': 5}
              //   });
      });
    </script>
    <script type="text/javascript">
    $(document).ready(function(){
        var messageArray = "";
        function timeConverter(UNIX_timestamp){
          var a = new Date(UNIX_timestamp * 1000);
          var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          var year = a.getFullYear();
          var month = months[a.getMonth()];
          var date = a.getDate();
          var hour = a.getHours();
          var min = a.getMinutes() < 10 ? '0' + a.getMinutes() : a.getMinutes();
          var sec = a.getSeconds() < 10 ? '0' + a.getSeconds() : a.getSeconds();
          var time = date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec ;
          return time;
        }
        console.log("messageArray 1is: " + messageArray);
        $(function() {
          $.ajax(
          {
            url: 'request/get_recent_posts',
            type: 'post',
            dataType: 'json',
            data: {'latitude': 10, 'longitude': 10},
            async: false,
            success: function(data) {
              messageArray = data
              var trHTML = '';
              $.each(messageArray, function(index, value){
                trHTML += '<tr><td>' + decodeURI(value['message']) + '</td><td>' + value['happiness_level'] + '/5' + '</td><td>' + decodeURI(value['location']['logical_location']) + '</td><td>' + timeConverter(value['timestamp']) + '</td><td>' + value['user_id'] + '</td><td>' + value['reactions']['upvote'] + '</td></tr>' ;
              });
              $('#tuffy').append(trHTML);
            },
            error: function(msg) {
              alert(msg.responseText);
            }
          });

          //AA: make function for different welcome messages based on last vote:
          //TODO:   pull most recent happinesslevel, parameter to welcomeText(X)          
          //right now it just takes happiness of the most recent post, 
          //which is not what we want in the end obviously
          document.body.onload = welcomeText(messageArray[0]['happiness_level']);

          function welcomeText(happy_lvl){
            var welcome = ""
            switch(happy_lvl){
              case 1:
                welcome = "<h4 style=\"color:SlateBlue; text-align:left;\">1/5?!?! Why are you so sad?</h4>";
                break;
              case 2:
                welcome ="<h4 style=\"color:DodgerBlue; text-align:left;\">2/5? Tell us why you're feeling blue...</h4>";
                break;
              case 3:
                welcome ="<h4 style=\"color:Orange; text-align:left;\">Keep your chin up, and tell us why you feel so 3 right now</h4>";
                break;
              case 4:
                welcome ="<h4 style=\"color:Yellow; text-align:left;\">4/5? Nice! How come?</h4>";
                break;
              case 5:
                welcome = "<h4 style=\"color:MediumSeaGreen; text-align:left;\">You're too happy. Tell us why...</h4>";
                break;
              default:
                welcome.append("Vote first, then post!");
            }
           document.getElementById("welcome").innerHTML = welcome;
          }

        });
      });
          //if we wanted it displayed in its own column (like before)
          //   $("#posts").append(decodeURI(value['message']) + '<br>');
          //   $("#votes").append(value['happiness_level'] + '/5' + '<br>');
          //   $("#time").append(timeConverter(value['timestamp']) + '<br>');
          //   $("#userid").append(decodeURI(value['location']['logical_location']) + '<br>');

    </script>
    <script>
      $(function() {
        $("#myform").submit(function(e) {
          e.preventDefault();
          $.ajax({
              url: 'request/add_post',
              type: 'post',
              dataType: 'json',
              data: {'latitude': 10, 'longitude': 10, 'message': $("#myform").serialize().slice(8), 'logical_location': "Maclean"},
              success: function(data) {
                'request/upvote'
                 console.log("added post successfully");
                 //console.log(decodeURI($(data))
                 console.log("my form input: " + $("#myform").serialize().slice(8));
              }
          });
        });
       
        // $("#upvote").submit(function(e){
        //   e.preventDefault();
        //   $.ajax({
        //     url: 'request/upvote',
        //     type: 'post',
        //     dataType: 'json',
        //     data: {'upvotes': }
        //   })
        // })



    });
    </script>
    <div class="homepage">
      <div class="cover-container d-flex h-100 p-3 mx-auto flex-column">
        <div id="myNav"></div>
        <main role="main" class="inner cover text-center" id="home-cover">
          <h1 class="cover-heading">Message Board</h1>
            <!-- THIS is where 'welcomeText' goes when called on load: -->
                <div id="welcome"></div>          
        </main>

        <form id="myform" method="post">
          <div class="form-group">

            <input type="text" class="form-control" id="exampleInputName2" placeholder="Let the world know!" name="message">
          </div>
          <button type="submit" onclick="window.location.reload()" class="btn btn-primary">Submit</button>
        </form>

        <div class="card w-100 p-3 mt-3" style="overflow-y: scroll">
          <img class="card-img-top" alt="">
          <div class="card-body">
            <!--  How we did it before:
              <div class="d-flex justify-content-between">
              <h5 class="card-title">Post</h5>
              <h5 class="card-title">Happiness Level</h5>
              <h5 class="card-title">Datetime</h5>
              <h5 class="card-title">User ID</h5>
              <h5 class="card-title">Log Location</h5>
            </div> -->
            <div class="d-flex justify-content-between">

                  <table id="tuffy" border='2' class="table table-hover table-border">
                      <tr>
                          <th scope="col">Messages</th>
                          <th scope="col">Happiness Level</th>
                          <th scope="col">Location</th>
                          <th scope="col">Time Stamp</th>
                          <th scope="col">User ID</th>
                          <th scope="col">Upvote</th>
                      </tr>
                  </table>
                  <!-- Previously:
                  <div id="posts"></div>
                  <div id="votes"></div>
                  <div id="time"></div>
                  <div id="userid"></div>
                  <div>
                    </button>
                  </div> -->

            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>